import db from '../services/index.js';
import logger from '../utils/logger.js';

<% if(database && databaseName === 'MongoDB') { -%>
let reconnectAttempts = 0;

async function setupDatabase() {
    try {
        await db.mongoose.connect(db.url, {});
        logger.info(`Database connected - ${db.url}`);
    } catch (err) {
        logger.error('Failed to connect to the database');
        process.exit(1);
    }

    const dbConnection = db.mongoose.connection;

    dbConnection.on('err', (err) => {
        logger.error('Error connecting to the database');
    });

    dbConnection.on('disconnected', () => {
        logger.error('Connection to the database lost');
        if (reconnectAttempts < 3) {
            reconnectAttempts++;
            setTimeout(async () => {
                try {
                    await db.mongoose.connect(db.url, {});
                    logger.info(`Database connected - ${db.url}`);
                    reconnectAttempts = 0;
                } catch (err) {
                    logger.error('Error reconnecting to the database');
                }
            }, 10000);
        } else {
            logger.error(`Failed to reconnect to the database 3 times - stopping the connection process`);
            process.exit(1);
        }
    });
}

export default setupDatabase;
<% } -%>
