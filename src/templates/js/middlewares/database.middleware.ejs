/*
    Middleware for establishing a connection to the database
*/

import db from '../services/index.js';
import logger from '../utils/logger.js';
<% if(database && databaseType === 'PostgreSQL') { -%>
import pg from 'pg';  
<% } -%>

async function setupDatabase() {
<% if(database && databaseType === 'MongoDB') { -%>
    try {
        await db.mongoose.connect(db.url, {});
        logger.info(`Database connected - ${db.url}`);
    } catch (err) {
        logger.error(err, 'Failed to connect to the MongoDB');
        process.exit(1);
    }
<% } -%>
<% if(database && databaseType === 'PostgreSQL') { -%>
    try {
        const host = process.env.DOCKER ? 'host.docker.internal' : 'localhost';
        const client = new pg.Client({
            host: host,
            database: 'postgres',
            user: db.user,
            port: 5432,
        });
        await client.connect();
        const result = await client.query(`SELECT FROM pg_database WHERE datname = '<%= databaseName %>';`);

        if (result.rows.length === 0) {
            await client.query('CREATE DATABASE <%= databaseName%>;');
        }
        await client.end();
    } catch (err) {
        logger.error(err, 'Error creating or checking PostgreSQL');
        process.exit(1);
    } finally {
        try {
            await db.sequelize.authenticate();
            await db.sequelize.sync();
            logger.info(`Database connected - ${db.url}`);
        } catch (err) {
            logger.error(err, 'Failed to connect to the PostgreSQL');
            process.exit(1);
        }
    } 
<% } -%>
}

export default setupDatabase;
